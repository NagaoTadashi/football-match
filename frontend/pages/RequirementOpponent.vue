<script setup>
import { nextTick, ref, watch } from 'vue';

const user = await getCurrentUser();
const idToken = await user.getIdToken();

const runtimeConfig = useRuntimeConfig();

const { data: teamInfo } = await useFetch(
    `${runtimeConfig.public.apiUrl}/team_info/`,
    {
        method: 'GET',
        headers: {
            Authorization: `Bearer ${idToken}`,
            'Content-Type': 'application/json',
        },
    }
);

const { data: recruitments } = await useFetch(
    `${runtimeConfig.public.apiUrl}/my_team_recruitments/`,
    {
        method: 'GET',
        headers: {
            Authorization: `Bearer ${idToken}`,
            'Content-Type': 'application/json',
        },
    }
);

const postDialog = ref(false);
const reservationDialog = ref(false);
const dialogDelete = ref(false);

const headers = ref([
    { title: '状態', align: 'start', key: 'status' },
    { title: '年', key: 'year', sortable: false },
    { title: '月', key: 'month', sortable: false },
    { title: '日', key: 'day', sortable: false },
    { title: '開始', key: 'start_time', sortable: false },
    { title: '終了', key: 'end_time', sortable: false },
    { title: '場所', key: 'location', sortable: false },
    { title: '', key: 'actions', sortable: false },
]);

const itemId = ref(-1);
const editedItem = ref({
    year: null,
    month: null,
    day: null,
    start_time: '',
    end_time: '',
    location: '',
});
const defaultItem = ref({
    year: null,
    month: null,
    day: null,
    start_time: '',
    end_time: '',
    location: '',
});

async function postRecruitment() {
    const postedRecruitment = await $fetch(
        `${runtimeConfig.public.apiUrl}/recruitments/`,
        {
            method: 'POST',
            headers: {
                Authorization: `Bearer ${idToken}`,
                'Content-Type': 'application/json',
            },
            body: editedItem.value,
        }
    );
    recruitments.value.push(postedRecruitment);
}

async function deleteRecruitment(id) {
    await $fetch(`${runtimeConfig.public.apiUrl}/recruitments/${id}/`, {
        method: 'DELETE',
    });

    recruitments.value = recruitments.value.filter(
        (recruitment) => recruitment.id !== id
    );
}

function close() {
    postDialog.value = false;
    nextTick(() => {
        editedItem.value = Object.assign({}, defaultItem.value);
        itemId.value = -1;
    });
}

function save() {
    postRecruitment();
    close();
}

function deleteItem(item) {
    itemId.value = item.id;
    dialogDelete.value = true;
}

function closeDelete() {
    dialogDelete.value = false;
    nextTick(() => {
        itemId.value = -1;
    });
}

function deleteItemConfirm() {
    deleteRecruitment(itemId.value);
    closeDelete();
}

const goToUrl = (url) => {
    window.open(url, '_blank');
};

const currentYear = new Date().getFullYear();
const yearOptions = [currentYear, currentYear + 1];

const monthOptions = Array.from({ length: 12 }, (_, i) => i + 1);

const dayOptions = Array.from({ length: 31 }, (_, i) => i + 1);

// 1時間間隔で時間を生成する関数
const generateTimeOptions = () => {
    const times = [];
    for (let hour = 0; hour < 24; hour++) {
        // 時間を "HH:00" 形式にフォーマット
        const formattedTime = `${String(hour).padStart(2, '0')}:00`;
        times.push(formattedTime);
    }
    return times;
};

const timeOptions = generateTimeOptions();

watch(postDialog, (val) => {
    val || close();
});
watch(dialogDelete, (val) => {
    val || closeDelete();
});

const isValid = computed(() => {
    return (
        editedItem.value.year &&
        editedItem.value.month &&
        editedItem.value.day &&
        editedItem.value.start_time &&
        editedItem.value.end_time &&
        editedItem.value.location
    );
});

const oitaGrounds = [
    {
        title: '大分県サッカー協会人工芝グラウンド',
        url: 'https://oita-s-c.resv.jp/reserve/calendar.php?x=1731748018',
    },
    {
        title: '大分県のその他のグラウンド',
        url: 'https://www.pa-reserve.jp/eap-rjt/rsv_rj/Core_i/init.asp?KLCD=449999&SBT=1&Target=_Top&LCD=',
    },
];
</script>

<template>
    <div v-if="teamInfo === null">
        <v-empty-state
            class="d-flex align-center justify-center"
            style="min-height: 300px"
            icon="mdi-tshirt-crew"
            title="チーム情報が登録されていません"
        >
            <template #text>
                「<v-icon left>mdi-tshirt-crew</v-icon>
                チーム情報」より、まずはじめにチーム情報を登録してください
            </template>
        </v-empty-state>
    </div>
    <div v-else>
        <v-data-table
            :headers="headers"
            :items="recruitments"
            :sort-by="[
                { key: 'year', order: 'desc' },
                { key: 'month', order: 'desc' },
                { key: 'day', order: 'desc' },
            ]"
        >
            <template v-slot:top>
                <v-toolbar class="px-2">
                    <v-toolbar-title>投稿済みの募集一覧</v-toolbar-title>
                    <v-divider class="mx-4" inset vertical></v-divider>
                    <v-spacer></v-spacer>

                    <v-btn
                        prepend-icon="mdi-text-box-plus-outline"
                        elevation="5"
                        @click="postDialog = true"
                    >
                        募集を投稿
                    </v-btn>

                    <v-dialog v-model="postDialog" max-width="500px">
                        <v-card prepend-icon="mdi-form-select" title="募集内容">
                            <v-card-text>
                                <v-container>
                                    <v-row>
                                        <v-col class="d-flex align-center">
                                            <v-icon>mdi-soccer-field</v-icon>
                                        </v-col>
                                        <v-col cols="10" md="10" sm="7"
                                            ><v-btn
                                                evaluation="10"
                                                @click="
                                                    reservationDialog = true
                                                "
                                            >
                                                グラウンドを予約
                                            </v-btn>
                                            <v-dialog
                                                v-model="reservationDialog"
                                                max-width="450"
                                            >
                                                <v-card>
                                                    <v-card-title>
                                                        予約可能なグラウンド
                                                    </v-card-title>

                                                    <v-divider></v-divider>
                                                    <v-virtual-scroll
                                                        :items="oitaGrounds"
                                                        height="300"
                                                        item-height="50"
                                                    >
                                                        <template
                                                            v-slot:default="{
                                                                item,
                                                            }"
                                                        >
                                                            <v-list-item>
                                                                <v-list-item-title
                                                                    >{{
                                                                        item.title
                                                                    }}</v-list-item-title
                                                                >
                                                                <template
                                                                    v-slot:append
                                                                >
                                                                    <v-btn
                                                                        @click="
                                                                            goToUrl(
                                                                                item.url
                                                                            )
                                                                        "
                                                                        >予約ページへ</v-btn
                                                                    >
                                                                </template>
                                                            </v-list-item>
                                                        </template>
                                                    </v-virtual-scroll>
                                                    <template v-slot:actions>
                                                        <v-btn
                                                            class="ms-auto"
                                                            color="primary"
                                                            variant="tonal"
                                                            text="閉じる"
                                                            @click="
                                                                reservationDialog = false
                                                            "
                                                        ></v-btn>
                                                    </template>
                                                </v-card>
                                            </v-dialog>
                                        </v-col>
                                    </v-row>
                                    <v-row>
                                        <v-col class="d-flex align-center">
                                            <v-icon
                                                >mdi-map-marker-outline</v-icon
                                            >
                                        </v-col>
                                        <v-col cols="10" md="10" sm="7">
                                            <v-text-field
                                                v-model="editedItem.location"
                                                hide-details="auto"
                                                label="開催場所を入力"
                                                clearable
                                            ></v-text-field>
                                        </v-col>
                                    </v-row>
                                    <v-row>
                                        <v-col class="d-flex align-center">
                                            <v-icon>
                                                mdi-calendar-month
                                            </v-icon>
                                        </v-col>
                                        <v-col md="4" sm="7">
                                            <v-select
                                                v-model="editedItem.year"
                                                label="年"
                                                :items="yearOptions"
                                            />
                                        </v-col>
                                        <v-col md="3" sm="7">
                                            <v-select
                                                v-model="editedItem.month"
                                                label="月"
                                                :items="monthOptions"
                                            />
                                        </v-col>
                                        <v-col md="3" sm="7">
                                            <v-select
                                                v-model="editedItem.day"
                                                label="日"
                                                :items="dayOptions"
                                            />
                                        </v-col>
                                    </v-row>
                                    <v-row>
                                        <v-col class="d-flex align-center">
                                            <v-icon>
                                                mdi-clock-time-eight-outline
                                            </v-icon>
                                        </v-col>
                                        <v-col cols="5" md="5" sm="7">
                                            <v-select
                                                v-model="editedItem.start_time"
                                                label="開始時間"
                                                :items="timeOptions"
                                            />
                                        </v-col>
                                        <v-col cols="5" md="5" sm="7">
                                            <v-select
                                                v-model="editedItem.end_time"
                                                label="終了時間"
                                                :items="timeOptions"
                                            />
                                        </v-col>
                                    </v-row>
                                </v-container>
                            </v-card-text>

                            <v-divider></v-divider>

                            <v-card-actions>
                                <v-spacer></v-spacer>

                                <v-btn
                                    text="キャンセル"
                                    variant="plain"
                                    @click="close"
                                >
                                </v-btn>

                                <v-btn
                                    color="primary"
                                    text="保存"
                                    variant="tonal"
                                    @click="save"
                                    :disabled="!isValid"
                                >
                                </v-btn>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>
                    <v-dialog v-model="dialogDelete" max-width="500px">
                        <v-card
                            prepend-icon="mdi-alert-circle-outline"
                            title="この募集投稿を削除してもよろしいですか？"
                        >
                            <v-card-actions>
                                <v-spacer></v-spacer>
                                <v-btn
                                    text="キャンセル"
                                    variant="plain"
                                    @click="closeDelete"
                                ></v-btn>
                                <v-btn
                                    color="primary"
                                    text="OK"
                                    variant="tonal"
                                    @click="deleteItemConfirm"
                                ></v-btn>
                                <v-spacer></v-spacer>
                            </v-card-actions>
                        </v-card>
                    </v-dialog>
                </v-toolbar>
            </template>
            <template v-slot:[`item.actions`]="{ item }">
                <v-icon
                    v-if="item.status === '募集中'"
                    color="#F44336"
                    class="me-2"
                    @click="deleteItem(item)"
                    v-tooltip:top="'削除'"
                >
                    mdi-delete
                </v-icon>
            </template>
            <template v-slot:no-data> 募集が投稿されていません </template>
        </v-data-table>
    </div>
</template>
